@startuml DFD_Registration
!define RECTANGLE class

title DFD Уровень 2 - Процесс 1: Регистрация пользователей

skinparam roundcorner 20
skinparam defaultTextAlignment center

' Внешние сущности
actor "HR менеджер" as hr #LightBlue
actor "Администратор" as admin #LightBlue

' Подпроцессы регистрации
circle "**1.1**\n\nВвод и валидация\nперсональных данных" as p11 #Orange
circle "**1.2**\n\nЗахват и обработка\nбиометрии" as p12 #Orange
circle "**1.3**\n\nГенерация\nface embeddings" as p13 #Orange
circle "**1.4**\n\nНазначение\nправ доступа" as p14 #Orange
circle "**1.5**\n\nСохранение\nв базе данных" as p15 #Orange

' Хранилища данных
database "D1.1: Пользователи\n(users table)" as db_users #Yellow
database "D1.2: Биометрия\n(embeddings)" as db_bio #Yellow
database "D1.3: Транспорт\n(vehicles)" as db_vehicles #Yellow
database "D1.4: Права доступа\n(access_rights)" as db_rights #Yellow
database "D1.5: Изображения\n(MinIO)" as db_images #Yellow
database "D1.6: Векторный индекс\n(Faiss)" as db_faiss #Yellow

' Kafka
queue "Kafka" as kafka #Pink

' Потоки данных
hr --> p11 : "D1: ФИО, должность,\nподразделение, контакты"
admin --> p11 : "D2: Роль в системе"

' Процесс 1.1: Ввод и валидация
p11 --> p15 : "D3: Валидированные\nперсональные данные"
db_users --> p11 : "D4: Проверка\nуникальности email"

' Процесс 1.2: Захват биометрии
hr --> p12 : "D5: Фотографии лица\n(5+ изображений)"
p12 --> p13 : "D6: Нормализованные\nизображения (112×112)"
p12 --> db_images : "D7: Оригинальные\nфото (архив)"

' Процесс 1.3: Генерация embeddings
p13 --> p15 : "D8: Face embeddings\n(512-dim vectors)"
p13 --> db_faiss : "D9: Индексация\nвектора"

' Процесс 1.4: Назначение прав
admin --> p14 : "D10: Политика\nдоступа"
hr --> p14 : "D11: Зоны доступа,\nрасписание"
p14 --> p15 : "D12: Правила доступа\n(роль, зоны, время)"

' Процесс 1.5: Сохранение в БД
p15 --> db_users : "D13: INSERT\nuser profile"
p15 --> db_bio : "D14: INSERT\nembeddings"
p15 --> db_rights : "D15: INSERT\naccess rules"

hr --> p15 : "D16: Данные\nтранспорта (опц.)"
p15 --> db_vehicles : "D17: INSERT\nvehicle data"

' События
p15 --> kafka : "D18: Событие\nuser.registered"

' Уведомления
p15 --> hr : "D19: Подтверждение\nрегистрации"

note right of p11
  **Процесс 1.1**:
  - Валидация формата данных
  - Проверка обязательных полей
  - Проверка уникальности email/телефона
  - Генерация User ID (UUID)
  
  **Выход**: Структурированный user object
end note

note right of p12
  **Процесс 1.2**:
  - Проверка качества фото
  - Детекция лица (RetinaFace)
  - Проверка размера лица (≥30%)
  - Alignment по landmarks
  - Resize до 112×112
  - Нормализация яркости
  
  **Требования**: минимум 5 фото
  разных ракурсов
end note

note right of p13
  **Процесс 1.3**:
  **Модель**: ArcFace (ResNet-100)
  
  **Шаги**:
  1. Загрузка модели (если не в памяти)
  2. Inference для каждого фото
  3. Получение 512-dim векторов
  4. Усреднение векторов
  5. L2 нормализация
  
  **Время**: ~500ms на 5 фото (GPU)
  **Выход**: 1 усредненный embedding
end note

note right of p14
  **Процесс 1.4**:
  **Параметры доступа**:
  - Роль: employee/visitor/contractor
  - Зоны: [entrance, parking, building_A, ...]
  - Время: рабочие часы (08:00-18:00)
  - Дни недели: пн-пт / круглосуточно
  - Срок действия: до даты / бессрочно
  
  **RBAC**: Role-Based Access Control
end note

note right of p15
  **Процесс 1.5**:
  **Транзакция БД** (ACID):
  ```sql
  BEGIN TRANSACTION;
    INSERT INTO users (...);
    INSERT INTO biometrics (...);
    INSERT INTO access_rights (...);
    [INSERT INTO vehicles (...);]  -- optional
  COMMIT;
  ```
  
  **Шифрование**:
  - Персональные данные: AES-256
  - Биометрия: encrypted at rest
  
  **Rollback** при ошибке любого INSERT
end note

note bottom of kafka
  **Событие user.registered**:
  ```json
  {
    "event_id": "uuid",
    "event_type": "user.registered",
    "user_id": "12345",
    "created_by": "hr_manager_id",
    "timestamp": "2025-11-18T10:00:00Z",
    "metadata": {
      "role": "employee",
      "department": "IT"
    }
  }
  ```
  
  **Consumers**: 
  - Audit Service (логирование)
  - Notification Service (welcome email)
end note

@enduml
