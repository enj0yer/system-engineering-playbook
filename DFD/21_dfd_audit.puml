@startuml DFD_Audit
!define RECTANGLE class

title DFD Уровень 2 - Процесс 4: Аудит и логирование

skinparam roundcorner 20
skinparam defaultTextAlignment center

' Внешние сущности
actor "Администратор" as admin #LightBlue
database "Внешние системы\n(ERP, Time tracking)" as external #LightGreen

' Подпроцессы аудита
circle "**4.1**\n\nСбор событий\nиз Kafka" as p41 #Orange
circle "**4.2**\n\nОбработка и\nобогащение\nданных" as p42 #Orange
circle "**4.3**\n\nИндексация\nи хранение" as p43 #Orange
circle "**4.4**\n\nГенерация\nотчетов" as p44 #Orange
circle "**4.5**\n\nВизуализация\nи аналитика" as p45 #Orange

' Хранилища данных
database "D4.1: События\n(PostgreSQL)" as db_events #Yellow
database "D4.2: Поиск\n(Elasticsearch)" as db_elastic #Yellow
database "D4.3: Архив\n(MinIO cold)" as db_archive #Yellow
database "D4.4: Пользователи\n(enrichment)" as db_users #Yellow
database "D4.5: Отчеты\n(generated)" as db_reports #Yellow
database "D4.6: Метрики\n(Prometheus)" as db_metrics #Yellow

' Kafka
queue "Kafka" as kafka #Pink

' Потоки данных

' Процесс 4.1: Сбор событий
kafka --> p41 : "D1: recognition.face"
kafka --> p41 : "D2: recognition.vehicle"
kafka --> p41 : "D3: access.decision"
kafka --> p41 : "D4: user.registered"
kafka --> p41 : "D5: notifications"
kafka --> p41 : "D6: audit.system"

p41 --> p42 : "D7: Batch событий\n(JSON array)"

' Процесс 4.2: Обработка и обогащение
db_users --> p42 : "D8: Данные\nпользователей"
p42 --> p43 : "D9: Обогащенные\nсобытия"

' Процесс 4.3: Индексация и хранение
p43 --> db_events : "D10: INSERT в\nPostgreSQL (warm)"
p43 --> db_elastic : "D11: Bulk index\nв Elasticsearch (hot)"
p43 --> db_metrics : "D12: Метрики\nдля Prometheus"

db_events --> p43 : "D13: Старые данные\n(>90 дней)"
p43 --> db_archive : "D14: Архивация\nв MinIO (cold)"

' Процесс 4.4: Генерация отчетов
admin --> p44 : "D15: Запрос\nотчета (параметры)"
db_elastic --> p44 : "D16: Горячие\nданные (0-7 дней)"
db_events --> p44 : "D17: Теплые\nданные (7-90 дней)"
db_archive --> p44 : "D18: Холодные\nданные (>90 дней)"
db_users --> p44 : "D19: Справочная\nинформация"

p44 --> db_reports : "D20: Сгенерированный\nотчет (PDF/Excel)"
p44 --> admin : "D21: Ссылка на\nскачивание"

' Процесс 4.5: Визуализация
db_metrics --> p45 : "D22: Time-series\nметрики"
db_elastic --> p45 : "D23: События в\nреальном времени"
db_events --> p45 : "D24: Агрегированная\nстатистика"

p45 --> admin : "D25: Дашборды\n(Grafana)"

' Экспорт данных
p44 --> external : "D26: Экспорт\nданных о проходах"

note right of p41
  **Процесс 4.1**:
  **Kafka Consumer**:
  - Consumer group: audit-service
  - Subscribe to ALL topics (wildcard *)
  - Partitions: 8 (для параллелизма)
  - Max poll: 500 events
  - Poll interval: 100ms
  
  **Topics**:
  - recognition.face (распознавание лиц)
  - recognition.vehicle (распознавание авто)
  - access.decision (решения о доступе)
  - user.registered (регистрации)
  - notifications (уведомления)
  - audit.system (системные события)
  
  **Batch processing**:
  - Accumulate events in buffer
  - Flush every 100 events OR 5 seconds
  - Reduces I/O operations
  
  **Error handling**:
  - Dead letter queue для невалидных событий
  - Retry mechanism (3 attempts)
  - Alerting при критических ошибках
  
  **Throughput**: ~100-500 events/sec
end note

note right of p42
  **Процесс 4.2**:
  **Обогащение данных**:
  
  1. **Пользовательские данные**:
     - user_id → Full name, department, role
     - Source: Redis cache / PostgreSQL
  
  2. **Геоданные**:
     - camera_id → Location name, coordinates
     - zone_id → Zone description
  
  3. **Временные метки**:
     - Добавление часового пояса
     - Вычисление duration (для access events)
  
  4. **Категоризация**:
     - Severity: INFO/WARNING/ERROR/CRITICAL
     - Category: security/operational/technical
  
  **Анонимизация** (GDPR):
  - Full name → First name + Initial
  - IP addresses → Subnet only
  - Removal of biometric data from logs
  
  **Структурирование**:
  ```json
  {
    "event_id": "uuid",
    "timestamp": "ISO8601",
    "event_type": "access.allowed",
    "severity": "INFO",
    "user_id": "12345",
    "user_name": "Иван И.",  // anonymized
    "zone": "main_entrance",
    "metadata": {...}
  }
  ```
  
  **Validation**:
  - JSON schema validation
  - Required fields check
  - Data type verification
  
  **Время**: ~5-10ms per event
end note

note right of p43
  **Процесс 4.3**:
  **Многоуровневое хранение**:
  
  **Hot storage** (0-7 дней):
  - **Elasticsearch**: 
    * Index pattern: events-{YYYY.MM.DD}
    * Shard strategy: 1 per day
    * Replicas: 1
    * Refresh: 1s (near real-time)
  - **Purpose**: Быстрый поиск, real-time мониторинг
  - **Latency**: <100ms
  - **Size**: ~700 MB (7 days × 100MB/day)
  
  **Warm storage** (7-90 дней):
  - **PostgreSQL**:
    * Table: events (partitioned by month)
    * Indexes: timestamp, user_id, event_type
    * Compression: pg_compress
  - **Purpose**: Отчеты, аналитика
  - **Latency**: ~500ms
  - **Size**: ~8 GB
  
  **Cold storage** (>90 дней):
  - **MinIO** (S3-compatible):
    * Compression: gzip
    * Format: Parquet (columnar)
    * Lifecycle: delete after 1 year
  - **Purpose**: Compliance, расследования
  - **Latency**: ~3-5 sec
  - **Size**: ~30 GB
  
  **Archiving job**:
  - Cron: daily at 02:00 AM
  - Move: ES → PostgreSQL (after 7 days)
  - Archive: PostgreSQL → MinIO (after 90 days)
  
  **Backup**:
  - PostgreSQL: daily incremental
  - Elasticsearch: snapshot weekly
  - MinIO: replication to secondary cluster
end note

note right of p44
  **Процесс 4.4**:
  **Типы отчетов**:
  
  **1. Посещаемость**:
  - Проходы по дням/неделям/месяцам
  - Группировка: user, department, zone
  - Метрики: total, unique users, avg time
  - Визуализация: таблицы, графики
  
  **2. Нарушения и инциденты**:
  - Отказы в доступе (по причинам)
  - Черный список alerts
  - Попытки несанкционированного доступа
  - Подозрительная активность
  
  **3. Технические метрики**:
  - Точность распознавания (confidence distribution)
  - Latency (p50, p95, p99)
  - Ошибки и downtime
  - Производительность камер
  
  **4. Аудит действий**:
  - Изменения в системе (кто, когда, что)
  - История доступа к данным
  - Изменения прав пользователей
  
  **Параметры запроса**:
  - date_from, date_to (период)
  - user_id / department (фильтр)
  - event_type (тип событий)
  - format: PDF / Excel / CSV
  
  **Асинхронная генерация**:
  - Celery task (background worker)
  - Task ID для polling статуса
  - Notification при готовности
  
  **Шаблоны** (Jinja2):
  - Predefined templates
  - Custom templates (admin)
  
  **Время генерации**: 10s - 5min
  (зависит от объема данных)
end note

note right of p45
  **Процесс 4.5**:
  **Дашборды в Grafana**:
  
  **1. Операционный дашборд**:
  - Live event stream (last 100 events)
  - Current pass counter (today)
  - Камеры: online/offline status
  - Последние алерты (severity ≥ WARNING)
  - Map view: события по зонам
  
  **2. Аналитический дашборд**:
  - Посещаемость (time series, 7/30/90 дней)
  - Распределение по часам (heat map)
  - Top-10 пользователей (по проходам)
  - Confidence score distribution (histogram)
  - ALLOW vs DENY ratio (pie chart)
  
  **3. Технический дашборд**:
  - **Производительность**:
    * CPU/GPU/RAM утилизация
    * Recognition latency (p50, p95, p99)
    * Throughput (events/sec)
  - **Инфраструктура**:
    * Kafka lag (consumer groups)
    * Database connections pool
    * MinIO storage usage
  - **Ошибки**:
    * Error rate (by service)
    * Failed recognitions
    * Controller timeouts
  
  **4. Безопасность дашборд**:
  - Blacklist detections (alerts)
  - Failed access attempts
  - Anomaly detection (ML-based)
  - Geographic anomalies
  
  **Источники данных**:
  - Prometheus: метрики приложений
  - Elasticsearch: события в реальном времени
  - PostgreSQL: агрегированная статистика
  
  **Refresh rate**: 
  - Real-time panels: 5-10 sec
  - Analytics: 1 min
  - Technical: 15 sec
  
  **Alerting** (Grafana Alerts):
  - Service down → CRITICAL
  - High error rate → HIGH
  - Blacklist detected → HIGH
  - Storage full → MEDIUM
  
  **Notifications**: Email, Telegram, PagerDuty
end note

note bottom of external
  **Экспорт во внешние системы**:
  
  **Time Tracking System**:
  - Данные о проходах (IN/OUT)
  - Format: JSON / CSV
  - Frequency: real-time (webhook) OR batch (daily)
  - Fields: user_id, timestamp, direction, zone
  
  **ERP System** (1C, SAP):
  - Учет рабочего времени
  - Format: XML / REST API
  - Frequency: daily batch (end of day)
  - Integration: bi-directional sync
  
  **BI Systems**:
  - Аналитические данные
  - Format: Parquet / CSV
  - Storage: S3 bucket (shared)
  - Update: daily
  
  **Compliance**:
  - Audit trails для регуляторов
  - Format: PDF reports
  - Encryption: PGP
  - Retention: as per legal requirements
end note

@enduml
