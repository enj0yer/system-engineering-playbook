@startuml DFD_Recognition
!define RECTANGLE class

title DFD Уровень 2 - Процесс 2: Распознавание лиц и автомобилей

skinparam roundcorner 20
skinparam defaultTextAlignment center

' Внешние сущности
database "IP-камера" as camera #LightGreen

' Подпроцессы распознавания
circle "**2.1**\n\nЗахват и\nдекодирование\nвидеопотока" as p21 #Orange
circle "**2.2**\n\nДетекция\nобъектов\n(лица, номера)" as p22 #Orange
circle "**2.3**\n\nИзвлечение\nпризнаков\n(embeddings, OCR)" as p23 #Orange
circle "**2.4**\n\nПоиск и\nсопоставление\nс базой" as p24 #Orange
circle "**2.5**\n\nФормирование\nи публикация\nсобытий" as p25 #Orange

' Хранилища данных
database "D2.1: Биометрия\n(face embeddings)" as db_bio #Yellow
database "D2.2: Транспорт\n(vehicle plates)" as db_vehicles #Yellow
database "D2.3: Пользователи\n(user data)" as db_users #Yellow
database "D2.4: Кэш\n(Redis)" as db_cache #Yellow
database "D2.5: Изображения\n(MinIO)" as db_images #Yellow
database "D2.6: Faiss индекс\n(vector search)" as db_faiss #Yellow

' Kafka
queue "Kafka" as kafka #Pink

' Потоки данных

' Процесс 2.1: Захват видео
camera --> p21 : "D1: RTSP поток\n(H.264, 25 FPS)"
p21 --> p22 : "D2: Декодированные\nRGB кадры (8-10 FPS)"

' Процесс 2.2: Детекция объектов
p22 --> p23 : "D3: BBox лиц +\nlandmarks (5 точек)"
p22 --> p23 : "D4: BBox номерных\nзнаков"
p22 --> db_images : "D5: Crops лиц\nи авто"

' Процесс 2.3: Извлечение признаков
p23 --> p24 : "D6: Face embeddings\n(512-dim vectors)"
p23 --> p24 : "D7: Распознанный\nтекст номера"
p23 --> db_images : "D8: Aligned faces\n(112×112)"

' Процесс 2.4: Поиск и сопоставление
db_faiss --> p24 : "D9: Поиск\nпохожих векторов"
db_bio --> p24 : "D10: Embeddings\nпользователей"
db_vehicles --> p24 : "D11: База\nномеров"
db_cache --> p24 : "D12: Кэшированные\nрезультаты"
db_users --> p24 : "D13: Данные\nпользователя"

p24 --> db_cache : "D14: Сохранение\nв кэш (TTL 5 мин)"

p24 --> p25 : "D15: User ID +\nconfidence score"
p24 --> p25 : "D16: Vehicle ID\n(если найден)"

' Процесс 2.5: Формирование событий
p25 --> kafka : "D17: Событие\nrecognition.face"
p25 --> kafka : "D18: Событие\nrecognition.vehicle"
p25 --> db_images : "D19: Метаданные\nизображений"

note right of p21
  **Процесс 2.1**:
  **Библиотеки**: FFmpeg, OpenCV
  
  **Действия**:
  - Подключение к RTSP (до 8 камер)
  - Декодирование H.264/H.265
  - Frame sampling (каждый 3-й кадр)
  - Буферизация для стабильности
  
  **Оптимизация**:
  - Пропуск кадров для снижения нагрузки
  - Обработка: 8-10 FPS (вместо 25)
  
  **Время**: ~10-20ms на кадр
  **Формат выхода**: numpy array (1080×1920×3)
end note

note right of p22
  **Процесс 2.2**:
  **Детекция лиц**:
  - Модель: RetinaFace / MTCNN
  - Min размер: 80×80 px
  - Output: BBox (x,y,w,h) + 5 landmarks
  
  **Детекция авто/номеров**:
  - Модель: YOLOv8 (fine-tuned)
  - Классы: vehicle, license_plate
  - Confidence threshold: ≥0.7
  
  **GPU Batch processing**:
  - Обработка нескольких кадров сразу
  - Оптимизация использования VRAM
  
  **Время**: ~50-100ms на кадр (GPU)
  
  **Фильтрация**:
  - Удаление дубликатов (tracking)
  - Quality check (размытие, окклюзии)
end note

note right of p23
  **Процесс 2.3**:
  **Face Recognition**:
  1. Alignment по 5 landmarks
  2. Resize до 112×112
  3. Нормализация пикселей
  4. Inference ArcFace model
  5. L2 normalization вектора
  
  **Output**: 512-dim float32 vector
  
  **OCR для номеров**:
  1. Предобработка (resize, denoise)
  2. Inference CRNN/EasyOCR
  3. Post-processing (pattern matching)
  4. Confidence filtering (≥0.9)
  
  **Output**: Text string (RU format)
  
  **Время**: ~100-150ms (batch GPU)
end note

note right of p24
  **Процесс 2.4**:
  **Vector Search** (Faiss):
  - Index type: IndexFlatIP (cosine)
  - Query: top-1 похожий вектор
  - Threshold: ≥0.6 (настраиваемый)
  - Время: ~10-20ms
  
  **Confidence levels**:
  - ≥0.95: HIGH (автоматический пропуск)
  - 0.6-0.95: MEDIUM (с логированием)
  - <0.6: LOW (требует подтверждения)
  
  **Кэширование** (Redis):
  - Key: embedding_hash → user_id
  - TTL: 5 минут
  - Benefit: skip vector search
  
  **Номера авто**:
  - SQL query: SELECT * FROM vehicles
    WHERE plate_number = ?
  - Index: B-tree на plate_number
  - Время: ~3-5ms
  
  **Обогащение данных**:
  - User name, role, department
  - Access rights
  - Photo URL
end note

note right of p25
  **Процесс 2.5**:
  **Структура события**:
  ```json
  {
    "event_id": "uuid",
    "timestamp": "ISO8601",
    "event_type": "face_recognition",
    "user_id": "12345",
    "user_name": "Иван Иванов",
    "confidence": 0.97,
    "camera_id": "cam_entrance_1",
    "zone": "main_entrance",
    "image_url": "s3://events/...",
    "face_bbox": [x, y, w, h],
    "landmarks": [[x1,y1], ...],
    "metadata": {...}
  }
  ```
  
  **Kafka Topics**:
  - recognition.face → Access Control
  - recognition.vehicle → Access Control
  
  **Async**: fire-and-forget (no blocking)
  **Time**: ~5ms
  
  **Метрики** (Prometheus):
  - recognition_total (counter)
  - recognition_confidence (histogram)
  - recognition_latency (histogram)
end note

note bottom of db_cache
  **Redis Cache Strategy**:
  
  **Hot data**:
  - Последние N распознаваний
  - Часто проходящие пользователи
  - Embeddings → User ID mapping
  
  **TTL**: 5-10 минут
  
  **Benefits**:
  - Снижение нагрузки на PostgreSQL
  - Ускорение повторных распознаваний
  - Reduce vector search calls
  
  **Memory**: ~2-4 GB (10K users cached)
end note

@enduml
