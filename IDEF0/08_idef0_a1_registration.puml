@startuml IDEF0_A1_Registration
!define RECTANGLE class

skinparam defaultTextAlignment center
skinparam classBackgroundColor LightYellow
skinparam classBorderColor Black
skinparam arrowColor Black

title IDEF0 - Декомпозиция A1: Регистрация пользователей

' Входы
rectangle "Персональные\nданные" as input1 #LightGreen
rectangle "Фотографии\nлица (5+)" as input2 #LightGreen
rectangle "Данные о\nтранспорте" as input3 #LightGreen

' Подфункции A1
rectangle "**A1.1**\n\nВВОД\nПЕРСОНАЛЬНЫХ\nДАННЫХ" as A11 #LightSkyBlue
rectangle "**A1.2**\n\nЗАХВАТ\nБИОМЕТРИИ" as A12 #LightSkyBlue
rectangle "**A1.3**\n\nГЕНЕРАЦИЯ\nEMBEDDINGS" as A13 #LightSkyBlue
rectangle "**A1.4**\n\nСОХРАНЕНИЕ\nВ БД" as A14 #LightSkyBlue

' Выходы
rectangle "Профиль\nпользователя" as output1 #LightCoral
rectangle "Face\nembeddings" as output2 #LightCoral
rectangle "Привязка\nтранспорта" as output3 #LightCoral

' Управление
rectangle "HR менеджер" as control1 #Lavender
rectangle "Политика\nбиометрии" as control2 #Lavender
rectangle "Модель ArcFace" as control3 #Lavender
rectangle "Схема БД" as control4 #Lavender

' Механизмы
rectangle "Web UI\nFastAPI" as mech1 #Wheat
rectangle "Камера/\nЗагрузка файлов" as mech2 #Wheat
rectangle "PyTorch\nGPU" as mech3 #Wheat
rectangle "PostgreSQL\nMinIO" as mech4 #Wheat

' Входные потоки
input1 -right-> A11 : "ФИО, должность,\nподразделение"
input2 -right-> A12 : "Изображения\nразных ракурсов"
input3 -down-> A14 : "Номер, марка,\nмодель, цвет"

' Связи между подфункциями
A11 -right-> A14 : "User ID,\nметаданные"
A12 -right-> A13 : "Нормализованные\nизображения лиц"
A13 -right-> A14 : "Векторы\nпризнаков (512-dim)"

' Выходные потоки
A14 -right-> output1 : "User profile\n(JSON)"
A13 -down-> output2 : "Embeddings\nдля поиска"
A14 -down-> output3 : "Vehicle\nassociation"

' Управление (сверху)
control1 -down-> A11 : "Авторизация,\nроль"
control2 -down-> A12 : "Требования\nк качеству фото"
control3 -down-> A13 : "Параметры\nмодели"
control4 -down-> A14 : "Структура\nданных"

' Механизмы (снизу)
mech1 -up-> A11 : "REST API\nвалидация"
mech2 -up-> A12 : "Захват\nизображений"
mech3 -up-> A13 : "Инференс\nмодели"
mech4 -up-> A14 : "Персистентное\nхранилище"

note right of A11
  **Входные данные**:
  - ФИО (кириллица)
  - Должность
  - Подразделение
  - Контакты
  - Роль в системе
  
  **Валидация**:
  - Уникальность email/телефона
  - Корректность формата
end note

note right of A12
  **Требования к фото**:
  - Разрешение ≥ 640x640
  - Лицо занимает ≥30% кадра
  - Хорошее освещение
  - Разные ракурсы (фас, ¾, профиль)
  - Без окклюзий
  
  **Обработка**:
  - Нормализация яркости
  - Выравнивание по landmarks
end note

note right of A13
  **Процесс**:
  1. Детекция лица (RetinaFace)
  2. Alignment (по 5 landmarks)
  3. Resize до 112x112
  4. Извлечение признаков (ArcFace)
  5. L2 нормализация вектора
  
  **Выход**: 512-dim float32 vector
end note

note right of A14
  **Транзакция БД**:
  - Таблица users (метаданные)
  - Таблица biometrics (embeddings)
  - Таблица vehicles (транспорт)
  - Таблица access_rights (права)
  
  **Шифрование**:
  - Персональные данные (AES-256)
  - Биометрия (зашифрована)
end note

@enduml
