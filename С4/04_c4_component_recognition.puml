@startuml C4_Component_Recognition
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_TOP_DOWN()

title Диаграмма компонентов (C4 Level 3) - Recognition Service

System_Ext(cameras, "IP-камеры", "RTSP видеопотоки")
Container_Ext(kafka, "Kafka", "Message Broker")
ContainerDb_Ext(minio, "MinIO", "Object Storage")
ContainerDb_Ext(redis, "Redis", "Cache")

Container_Boundary(recognition, "Recognition Service") {
    Component(stream_manager, "Stream Manager", "Python/asyncio", "Управление RTSP подключениями, мультиплексирование потоков")
    Component(frame_processor, "Frame Processor", "Python/OpenCV", "Обработка кадров, декодирование, нормализация")
    Component(face_detector, "Face Detector", "PyTorch/RetinaFace", "Детекция лиц в кадре, извлечение bbox и landmarks")
    Component(face_recognizer, "Face Recognizer", "PyTorch/ArcFace", "Извлечение face embeddings, сравнение с базой")
    Component(vehicle_detector, "Vehicle Detector", "PyTorch/YOLOv8", "Детекция транспортных средств и номерных знаков")
    Component(ocr_engine, "OCR Engine", "EasyOCR/CRNN", "Распознавание текста номерных знаков")
    Component(matching_engine, "Matching Engine", "Python/Faiss", "Поиск похожих face embeddings в векторной БД")
    Component(event_publisher, "Event Publisher", "Python/kafka-python", "Публикация событий распознавания в Kafka")
    Component(storage_manager, "Storage Manager", "Python/boto3", "Сохранение изображений в MinIO")
    Component(cache_manager, "Cache Manager", "Python/redis-py", "Кэширование результатов, управление состоянием")
    Component(model_loader, "Model Loader", "PyTorch", "Загрузка и управление ML моделями, warm-up")
    Component(gpu_scheduler, "GPU Scheduler", "Python/CUDA", "Оптимизация использования GPU, batch processing")
}

Rel(cameras, stream_manager, "Передает RTSP потоки", "RTSP/H.264")
Rel(stream_manager, frame_processor, "Передает кадры", "numpy array")
Rel(frame_processor, face_detector, "Передает обработанные кадры", "tensor")
Rel(frame_processor, vehicle_detector, "Передает обработанные кадры", "tensor")

Rel(face_detector, face_recognizer, "Передает bbox лиц", "coordinates + landmarks")
Rel(face_recognizer, matching_engine, "Передает embeddings для поиска", "512-dim vector")
Rel(matching_engine, redis, "Кэширует результаты поиска", "Redis Protocol")

Rel(vehicle_detector, ocr_engine, "Передает изображения номеров", "cropped image")
Rel(ocr_engine, cache_manager, "Кэширует распознанные номера", "")

Rel(face_recognizer, event_publisher, "Отправляет события распознавания лиц", "event object")
Rel(ocr_engine, event_publisher, "Отправляет события распознавания номеров", "event object")
Rel(event_publisher, kafka, "Публикует события", "recognition.face / recognition.vehicle")

Rel(face_detector, storage_manager, "Сохраняет изображения лиц", "image data")
Rel(vehicle_detector, storage_manager, "Сохраняет изображения авто", "image data")
Rel(storage_manager, minio, "Загружает файлы", "S3 API")

Rel(model_loader, face_detector, "Загружает модель", "model weights")
Rel(model_loader, face_recognizer, "Загружает модель", "model weights")
Rel(model_loader, vehicle_detector, "Загружает модель", "model weights")
Rel(model_loader, ocr_engine, "Загружает модель", "model weights")

Rel(gpu_scheduler, face_detector, "Планирует вычисления на GPU", "batch tensors")
Rel(gpu_scheduler, face_recognizer, "Планирует вычисления на GPU", "batch tensors")
Rel(gpu_scheduler, vehicle_detector, "Планирует вычисления на GPU", "batch tensors")

Rel(cache_manager, redis, "Управляет кэшем", "Redis Protocol")

SHOW_LEGEND()

@enduml
