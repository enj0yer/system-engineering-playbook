@startuml ComponentArchitecture

title Компонентная схема сервисов - Микросервисная архитектура

!define RECTANGLE class

skinparam componentStyle rectangle

package "Client Layer" {
  [Web UI\n(React)] as WebUI
  [Mobile App\n(React Native)] as MobileApp
  [Admin Panel\n(Vue.js)] as AdminPanel
}

package "API Gateway Layer" {
  [API Gateway\n(Kong/Traefik)] as Gateway
  [Load Balancer\n(nginx)] as LB
}

package "Application Services" {
  component "User Service" as UserSvc {
    [User Management] as UserMgmt
    [Biometrics Handler] as BioHandler
    [Vehicle Management] as VehicleMgmt
    [Access Rights] as AccessRights
  }
  
  component "Recognition Service" as RecSvc {
    [Stream Manager] as StreamMgr
    [Face Detector\n(RetinaFace)] as FaceDetector
    [Face Recognizer\n(ArcFace)] as FaceRecognizer
    [Vehicle Detector\n(YOLOv8)] as VehicleDetector
    [OCR Engine\n(EasyOCR)] as OCR
    [Matching Engine\n(Faiss)] as Matcher
  }
  
  component "Access Control Service" as AccessSvc {
    [Event Consumer] as EventConsumer
    [Decision Engine] as DecisionEngine
    [Rules Engine] as RulesEngine
    [Blacklist Checker] as BlacklistChecker
    [Controller Gateway] as CtrlGateway
    [Wiegand Driver] as Wiegand
    [RS-485 Driver] as RS485
  }
  
  component "Audit Service" as AuditSvc {
    [Event Aggregator] as EventAgg
    [Log Processor] as LogProcessor
    [Report Generator] as ReportGen
    [Analytics Engine] as Analytics
  }
  
  component "Notification Service" as NotifSvc {
    [Alert Manager] as AlertMgr
    [Email Sender] as EmailSender
    [Telegram Bot] as TelegramBot
    [Push Notifier] as PushNotifier
  }
}

package "Message Broker" {
  [Apache Kafka] as Kafka
  database "Zookeeper" as ZK
  
  Kafka --> ZK : "координация"
}

package "Data Layer" {
  database "PostgreSQL\n(Primary)" as PostgresPrimary
  database "PostgreSQL\n(Replica)" as PostgresReplica
  database "Redis\n(Cache)" as Redis
  database "Elasticsearch\n(Logs/Search)" as Elastic
  database "MinIO\n(Object Storage)" as MinIO
}

package "External Systems" {
  [IP Cameras\n(RTSP)] as Cameras
  [Access Controllers\n(Wiegand/RS-485)] as Controllers
  [ERP System\n(1C/SAP)" as ERP
  [Time Tracking] as TimeTracking
  [Email Server\n(SMTP)] as EmailServer
}

package "Monitoring & Logging" {
  [Prometheus] as Prometheus
  [Grafana] as Grafana
  [Logstash] as Logstash
  [Kibana] as Kibana
}

' Client to Gateway
WebUI --> LB : "HTTPS"
MobileApp --> LB : "HTTPS"
AdminPanel --> LB : "HTTPS"

LB --> Gateway : "HTTP/2"

' Gateway to Services
Gateway --> UserSvc : "REST API"
Gateway --> AccessSvc : "REST API"
Gateway --> AuditSvc : "REST API"

' Recognition Service connections
Cameras --> StreamMgr : "RTSP"
StreamMgr --> FaceDetector : "frames"
FaceDetector --> FaceRecognizer : "BBox + landmarks"
FaceDetector --> VehicleDetector : "frames"
VehicleDetector --> OCR : "plate crops"
FaceRecognizer --> Matcher : "embeddings"

' Service to Kafka
UserSvc --> Kafka : "user.* events"
RecSvc --> Kafka : "recognition.* events"
AccessSvc --> Kafka : "access.* events"
Kafka --> AccessSvc : "recognition.* events"
Kafka --> AuditSvc : "all events"
Kafka --> NotifSvc : "notifications"

' Service to Databases
UserSvc --> PostgresPrimary : "SQL"
UserSvc --> Redis : "cache"
UserSvc --> MinIO : "S3 API"

RecSvc --> Redis : "cache"
RecSvc --> MinIO : "S3 API"
Matcher --> Redis : "vector cache"

AccessSvc --> PostgresPrimary : "SQL"
AccessSvc --> Redis : "cache"

AuditSvc --> PostgresPrimary : "SQL"
AuditSvc --> Elastic : "HTTP"
AuditSvc --> MinIO : "S3 API"

' Database replication
PostgresPrimary --> PostgresReplica : "streaming\nreplication"

' Access Control to Controllers
CtrlGateway --> Wiegand
CtrlGateway --> RS485
Wiegand --> Controllers : "Wiegand 26/34-bit"
RS485 --> Controllers : "Modbus RTU"

' Notification Service to External
AlertMgr --> EmailSender
AlertMgr --> TelegramBot
AlertMgr --> PushNotifier
EmailSender --> EmailServer : "SMTP"

' Audit to External Systems
AuditSvc --> ERP : "REST API"
AuditSvc --> TimeTracking : "REST API / Webhook"

' Monitoring
UserSvc --> Prometheus : "metrics"
RecSvc --> Prometheus : "metrics"
AccessSvc --> Prometheus : "metrics"
AuditSvc --> Prometheus : "metrics"
Prometheus --> Grafana : "data source"

' Logging
UserSvc --> Logstash : "logs"
RecSvc --> Logstash : "logs"
AccessSvc --> Logstash : "logs"
AuditSvc --> Logstash : "logs"
Logstash --> Elastic : "index"
Elastic --> Kibana : "data source"

note right of Kafka
  **Topics**:
  - user.registered
  - user.updated
  - recognition.face
  - recognition.vehicle
  - access.decision
  - notifications
  - audit.system
  
  **Partitions**: 8
  **Replication**: 3
end note

note right of RecSvc
  **GPU Acceleration**:
  - NVIDIA GPU (CUDA)
  - PyTorch models
  - Batch processing
  - Model caching
  
  **Performance**:
  - 8 cameras simultaneous
  - ~200ms latency (p95)
  - 100+ recognitions/min
end note

note right of PostgresPrimary
  **High Availability**:
  - Master-Replica setup
  - Automatic failover
  - Streaming replication
  - Connection pooling (PgBouncer)
  
  **Data**:
  - Users, biometrics
  - Access rights, rules
  - Events history
  - Blacklist
end note

note right of Redis
  **Use Cases**:
  - Session cache
  - User data cache
  - Access rules cache
  - Rate limiting
  - Anti-tailgating tracking
  
  **Performance**:
  - <1ms latency
  - TTL-based expiration
  - Pub/Sub for invalidation
end note

@enduml
