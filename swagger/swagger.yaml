openapi: 3.0.3
info:
  title: Smart Checkpoint API
  description: |
    REST API для системы умного КПП на базе компьютерного зрения.
    
    ## Основные возможности:
    - Управление пользователями и биометрией
    - Управление правами доступа
    - Получение событий распознавания
    - Генерация отчетов и аналитика
    
    ## Аутентификация:
    Все endpoints требуют JWT токен в заголовке `Authorization: Bearer <token>`
    
  version: 1.0.0
  contact:
    name: API Support
    email: api@smartcheckpoint.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: https://api.checkpoint.example.com/api/v1
    description: Production server
  - url: https://staging-api.checkpoint.example.com/api/v1
    description: Staging server
  - url: http://localhost:8000/api/v1
    description: Local development

tags:
  - name: Users
    description: Управление пользователями
  - name: Biometrics
    description: Управление биометрическими данными
  - name: Vehicles
    description: Управление транспортом
  - name: Access Control
    description: Контроль доступа и права
  - name: Events
    description: События распознавания и проходов
  - name: Reports
    description: Отчеты и аналитика
  - name: System
    description: Системные операции

paths:
  # ============ USERS ============
  /users:
    get:
      tags: [Users]
      summary: Получить список пользователей
      description: Возвращает список пользователей с фильтрацией и пагинацией
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Номер страницы
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Количество записей на странице
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по ФИО, email, телефону
        - name: role
          in: query
          schema:
            type: string
            enum: [employee, visitor, contractor]
          description: Фильтр по роли
        - name: status
          in: query
          schema:
            type: string
            enum: [active, suspended, deleted]
          description: Фильтр по статусу
      responses:
        '200':
          description: Успешный ответ
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
      security:
        - bearerAuth: []

    post:
      tags: [Users]
      summary: Регистрация нового пользователя
      description: |
        Создает нового пользователя с биометрическими данными.
        
        **Требования к фото:**
        - Минимум 5 фотографий лица
        - Формат: JPEG, PNG
        - Разрешение: минимум 640×640 px
        - Размер файла: до 10 MB каждое
        - Разные ракурсы (фас, профиль, ¾)
      requestBody:
        required: true
        content:
          multipart/formw-data:
            schema:
              type: object
              required:
                - first_name
                - last_name
                - email
                - role
                - photos
              properties:
                first_name:
                  type: string
                  example: Иван
                last_name:
                  type: string
                  example: Иванов
                middle_name:
                  type: string
                  example: Иванович
                email:
                  type: string
                  format: email
                  example: ivan@example.com
                phone:
                  type: string
                  example: +79001234567
                department:
                  type: string
                  example: IT отдел
                position:
                  type: string
                  example: Разработчик
                role:
                  type: string
                  enum: [employee, visitor, contractor]
                  example: employee
                photos:
                  type: array
                  items:
                    type: string
                    format: binary
                  minItems: 5
                  maxItems: 10
      responses:
        '201':
          description: Пользователь успешно создан
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  message:
                    type: string
                    example: User registered successfully
                  embeddings_generated:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Пользователь с таким email уже существует
      security:
        - bearerAuth: []

  /users/{user_id}:
    get:
      tags: [Users]
      summary: Получить пользователя по ID
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Успешный ответ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

    put:
      tags: [Users]
      summary: Обновить данные пользователя
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                first_name:
                  type: string
                last_name:
                  type: string
                email:
                  type: string
                  format: email
                phone:
                  type: string
                department:
                  type: string
                position:
                  type: string
                status:
                  type: string
                  enum: [active, suspended]
      responses:
        '200':
          description: Пользователь обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

    delete:
      tags: [Users]
      summary: Деактивировать пользователя
      description: Soft delete - устанавливает status=deleted
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Пользователь деактивирован
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

  # ============ BIOMETRICS ============
  /users/{user_id}/biometrics:
    get:
      tags: [Biometrics]
      summary: Получить биометрические данные пользователя
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Успешный ответ
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  face_embeddings_count:
                    type: integer
                    example: 5
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  photos:
                    type: array
                    items:
                      type: object
                      properties:
                        photo_id:
                          type: string
                        url:
                          type: string
                        thumbnail_url:
                          type: string
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

    post:
      tags: [Biometrics]
      summary: Обновить биометрические данные
      description: Заменяет старые фото и embeddings новыми
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                photos:
                  type: array
                  items:
                    type: string
                    format: binary
                  minItems: 5
      responses:
        '200':
          description: Биометрия обновлена
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  embeddings_updated:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequestError'
      security:
        - bearerAuth: []

  # ============ VEHICLES ============
  /vehicles:
    get:
      tags: [Vehicles]
      summary: Получить список транспорта
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
          description: Фильтр по владельцу
        - name: plate_number
          in: query
          schema:
            type: string
          description: Поиск по номеру
      responses:
        '200':
          description: Список транспорта
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vehicle'
      security:
        - bearerAuth: []

    post:
      tags: [Vehicles]
      summary: Зарегистрировать транспорт
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - plate_number
              properties:
                user_id:
                  type: string
                  format: uuid
                plate_number:
                  type: string
                  example: А123ВС77
                  pattern: '^[АВЕКМНОРСТУХ]\d{3}[АВЕКМНОРСТУХ]{2}\d{2,3}$'
                make:
                  type: string
                  example: Toyota
                model:
                  type: string
                  example: Camry
                color:
                  type: string
                  example: Черный
                year:
                  type: integer
                  example: 2020
      responses:
        '201':
          description: Транспорт зарегистрирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'
        '400':
          $ref: '#/components/responses/BadRequestError'
      security:
        - bearerAuth: []

  # ============ ACCESS CONTROL ============
  /access-rights:
    get:
      tags: [Access Control]
      summary: Получить права доступа
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список прав доступа
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AccessRight'
      security:
        - bearerAuth: []

    post:
      tags: [Access Control]
      summary: Назначить права доступа
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AccessRight'
      responses:
        '201':
          description: Права назначены
        '400':
          $ref: '#/components/responses/BadRequestError'
      security:
        - bearerAuth: []

  /access-rights/{access_right_id}:
    delete:
      tags: [Access Control]
      summary: Отозвать права доступа
      parameters:
        - name: access_right_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Права отозваны
      security:
        - bearerAuth: []

  /blacklist:
    get:
      tags: [Access Control]
      summary: Получить черный список
      responses:
        '200':
          description: Черный список
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BlacklistEntry'
      security:
        - bearerAuth: []

    post:
      tags: [Access Control]
      summary: Добавить в черный список
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - reason
              properties:
                user_id:
                  type: string
                  format: uuid
                reason:
                  type: string
                  example: Уволен за нарушения
                blocked_until:
                  type: string
                  format: date-time
                  description: null = постоянная блокировка
      responses:
        '201':
          description: Добавлен в черный список
      security:
        - bearerAuth: []

  # ============ EVENTS ============
  /events:
    get:
      tags: [Events]
      summary: Получить события
      parameters:
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
        - name: event_type
          in: query
          schema:
            type: string
            enum: [face_recognition, vehicle_recognition, access_granted, access_denied]
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: zone
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: События
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
      security:
        - bearerAuth: []

  /events/{event_id}:
    get:
      tags: [Events]
      summary: Получить событие по ID
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Детали события
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '404':
          $ref: '#/components/responses/NotFoundError'
      security:
        - bearerAuth: []

  # ============ REPORTS ============
  /reports:
    post:
      tags: [Reports]
      summary: Создать отчет
      description: Асинхронная генерация отчета. Возвращает task_id для отслеживания прогресса
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - report_type
                - from_date
                - to_date
                - format
              properties:
                report_type:
                  type: string
                  enum: [attendance, violations, technical, audit]
                from_date:
                  type: string
                  format: date
                to_date:
                  type: string
                  format: date
                format:
                  type: string
                  enum: [pdf, excel, csv]
                filters:
                  type: object
                  properties:
                    user_id:
                      type: string
                      format: uuid
                    department:
                      type: string
                    zone:
                      type: string
      responses:
        '202':
          description: Задача создана
          content:
            application/json:
              schema:
                type: object
                properties:
                  task_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: pending
        '400':
          $ref: '#/components/responses/BadRequestError'
      security:
        - bearerAuth: []

  /reports/{task_id}:
    get:
      tags: [Reports]
      summary: Получить статус генерации отчета
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Статус задачи
          content:
            application/json:
              schema:
                type: object
                properties:
                  task_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [pending, processing, completed, failed]
                  progress:
                    type: integer
                    minimum: 0
                    maximum: 100
                  result:
                    type: object
                    properties:
                      download_url:
                        type: string
                      expires_at:
                        type: string
                        format: date-time
                      size_mb:
                        type: number
      security:
        - bearerAuth: []

  # ============ SYSTEM ============
  /system/health:
    get:
      tags: [System]
      summary: Health check
      responses:
        '200':
          description: Система работает
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  services:
                    type: object
                    properties:
                      database:
                        type: string
                        example: online
                      kafka:
                        type: string
                        example: online
                      recognition_service:
                        type: string
                        example: online
                  timestamp:
                    type: string
                    format: date-time

  /system/cameras:
    get:
      tags: [System]
      summary: Статус камер
      responses:
        '200':
          description: Список камер
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    camera_id:
                      type: string
                    name:
                      type: string
                    zone:
                      type: string
                    status:
                      type: string
                      enum: [online, offline, error]
                    rtsp_url:
                      type: string
                    fps:
                      type: integer
                    last_frame_at:
                      type: string
                      format: date-time
      security:
        - bearerAuth: []

# ============ COMPONENTS ============
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        first_name:
          type: string
        last_name:
          type: string
        middle_name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        department:
          type: string
        position:
          type: string
        role:
          type: string
          enum: [employee, visitor, contractor]
        status:
          type: string
          enum: [active, suspended, deleted]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Vehicle:
      type: object
      properties:
        vehicle_id:
          type: integer
        user_id:
          type: string
          format: uuid
        plate_number:
          type: string
        make:
          type: string
        model:
          type: string
        color:
          type: string
        year:
          type: integer
        created_at:
          type: string
          format: date-time

    AccessRight:
      type: object
      properties:
        access_right_id:
          type: integer
        user_id:
          type: string
          format: uuid
        zone:
          type: string
          example: main_entrance
        allowed_hours:
          type: object
          properties:
            start:
              type: string
              example: "08:00"
            end:
              type: string
              example: "18:00"
        allowed_days:
          type: array
          items:
            type: string
            enum: [monday, tuesday, wednesday, thursday, friday, saturday, sunday]
        valid_from:
          type: string
          format: date
        valid_until:
          type: string
          format: date

    BlacklistEntry:
      type: object
      properties:
        blacklist_id:
          type: integer
        user_id:
          type: string
          format: uuid
        reason:
          type: string
        blocked_at:
          type: string
          format: date-time
        blocked_until:
          type: string
          format: date-time
          nullable: true
        blocked_by:
          type: string
          format: uuid

    Event:
      type: object
      properties:
        event_id:
          type: string
          format: uuid
        event_type:
          type: string
          enum: [face_recognition, vehicle_recognition, access_granted, access_denied]
        timestamp:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
        user_name:
          type: string
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        camera_id:
          type: string
        zone:
          type: string
        image_url:
          type: string
        metadata:
          type: object

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total_pages:
          type: integer
        total_items:
          type: integer

  responses:
    BadRequestError:
      description: Ошибка валидации
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Validation error
              details:
                type: array
                items:
                  type: object
                  properties:
                    field:
                      type: string
                    message:
                      type: string

    UnauthorizedError:
      description: Не авторизован
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Unauthorized

    ForbiddenError:
      description: Доступ запрещен
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Forbidden

    NotFoundError:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Resource not found
