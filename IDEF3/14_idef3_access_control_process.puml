@startuml IDEF3_AccessControl
!define RECTANGLE class

title IDEF3 - Процесс контроля доступа (A3)

skinparam activity {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
}

|Kafka|
start
:Публикация события\nраспознавания;
note right
  **Действие 3.1**
  Topic: recognition.face
  Producer: Recognition Service
  Trigger для процесса контроля доступа
end note

|Access Control Service|
:Получение события\nиз Kafka;
note right
  **Действие 3.2**
  Consumer group: access-control
  Offset: auto-commit
  Deserialization: JSON → object
  Time: <10ms
end note

:Извлечение\nUser ID и metadata;
note right
  **Действие 3.3**
  Parse event:
  - user_id
  - confidence score
  - timestamp
  - camera_id (zone)
end note

if (Confidence ≥ 0.95?) then (да)
  :Автоматический режим;
  note right
    **Действие 3.4a**
    High confidence → skip manual check
    Fast track
  end note
else (нет)
  if (Confidence ≥ 0.6?) then (да)
    :Режим с логированием;
    note right
      **Действие 3.4b**
      Medium confidence → allow but log
      Potential review later
    end note
  else (нет)
    :Требуется подтверждение\nоператора;
    note right
      **Действие 3.4c**
      Low confidence → manual verification
      Alert security guard
      Pause: wait for operator decision
    end note
    
    |Оператор охраны|
    :Ручная проверка;
    note right
      **Действие 3.5**
      View image + user profile
      Decision: ALLOW / DENY
      Timeout: 30 seconds
    end note
    
    if (Оператор подтвердил?) then (нет)
      |Access Control Service|
      :DENY + причина;
      detach
    endif
    |Access Control Service|
  endif
endif

:Проверка статуса\nучетной записи;
note right
  **Действие 3.6**
  Query cache (Redis) or DB (PostgreSQL)
  Status: ACTIVE / SUSPENDED / DELETED
  Time: ~5ms (cache hit)
end note

if (Статус = ACTIVE?) then (нет)
  :DENY\n(неактивная запись);
  note right
    **Действие 3.7a**
    Reason: account_inactive
    Log attempt
  end note
  detach
else (да)
endif

:Проверка черного\nсписка;
note right
  **Действие 3.8**
  Query: blacklist table (indexed)
  Check: user_id exists?
  Time: ~5ms
end note

if (В черном списке?) then (да)
  :DENY + ALERT\nохране;
  note right
    **Действие 3.9**
    Reason: blacklisted
    Severity: HIGH
    Action: immediate alert to security
    Notification: Telegram/Push
  end note
  detach
else (нет)
endif

:Получение правил\nдоступа пользователя;
note right
  **Действие 3.10**
  Redis cache (TTL 10 min):
  - role (employee/visitor/contractor)
  - allowed_zones []
  - time_restrictions {}
  - valid_until (date)
  Fallback: PostgreSQL query
  Time: ~5ms (cache) / ~10ms (DB)
end note

:Проверка зоны\nдоступа;
note right
  **Действие 3.11**
  Current zone: from camera_id
  Allowed zones: from user profile
  Check: zone in allowed_zones?
end note

if (Зона разрешена?) then (нет)
  :DENY\n(нет прав на зону);
  note right
    **Действие 3.12a**
    Reason: zone_not_allowed
    Log unauthorized attempt
    Notify manager
  end note
  detach
else (да)
endif

:Проверка временных\nограничений;
note right
  **Действие 3.13**
  Current time: server timestamp
  Allowed hours: from profile (e.g., 08:00-18:00)
  Day of week: working days / weekends
end note

if (Время разрешено?) then (нет)
  :DENY\n(вне разрешенного времени);
  note right
    **Действие 3.14a**
    Reason: outside_allowed_hours
    Log attempt
    Optional: notify manager
  end note
  detach
else (да)
endif

:Anti-tailgating\nпроверка;
note right
  **Действие 3.15**
  Check last pass time for user
  Cooldown: 30 seconds
  Prevent multiple rapid passes
  (защита от прохода за кем-то)
end note

if (Cooldown истек?) then (нет)
  :DENY\n(слишком быстрая попытка);
  note right
    **Действие 3.16a**
    Reason: anti_tailgating
    Wait time remaining: X seconds
  end note
  detach
else (да)
endif

:Формирование решения\nALLOW;
note right
  **Действие 3.17**
  Decision: GRANT ACCESS
  Reason: all checks passed
  Metadata: {user_id, zone, timestamp}
end note

:Отправка команды\nконтроллеру;
note right
  **Действие 3.18**
  Target: barrier/turnstile controller
  Protocol: Wiegand 26-bit / RS-485 Modbus
  Command: OPEN
  Duration: 5 seconds (configurable)
  Timeout: 500ms
end note

|Контроллер доступа|
:Выполнение команды\nOPEN;
note right
  **Действие 3.19**
  Physical action: открытие барьера
  Duration: ~2-3 seconds
  Status feedback: OPENING → OPEN
end note

:Барьер открыт;
note right
  **Действие 3.20**
  User проходит через КПП
  Sensor: проход зафиксирован
end note

:Автоматическое\nзакрытие;
note right
  **Действие 3.21**
  Timeout: 5 seconds after opening
  Command: CLOSE
  Status: CLOSING → CLOSED
end note

|Access Control Service|
:Публикация решения\nв Kafka;
note right
  **Действие 3.22**
  Topic: access.decision
  Payload: {
    decision_id, user_id, decision: "ALLOW",
    zone, timestamp, reason
  }
  Consumer: Audit Service
end note

fork
  :Обновление счетчика\nпроходов;
  note right
    **Действие 3.23a**
    Redis: INCR pass_count:{user_id}:{date}
    Purpose: статистика
  end note
fork again
  :Обновление метрик\nPrometheus;
  note right
    **Действие 3.23b**
    Metrics:
    - access_decisions_total{decision="allow"}
    - access_latency (histogram)
  end note
fork again
  :Логирование\nуспешного доступа;
  note right
    **Действие 3.23c**
    Structured log (JSON)
    Level: INFO
    Destination: Logstash → Elasticsearch
  end note
end fork

:Проход завершен;
note right
  **Действие 3.24 (конец процесса)**
  Total time: ~100-200ms
  (от события распознавания до открытия барьера)
end note

stop

@enduml
