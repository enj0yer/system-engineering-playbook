@startuml BPMN_UserPass

title BPMN - Сценарий прохода пользователя через КПП

|Пользователь|
start
:Подойти к КПП;
:Встать перед камерой;

|Система распознавания|
:Захватить кадр\nс лицом пользователя;
:Детекция лица;
:Генерация embedding;
:Поиск в базе;

if (Лицо распознано?) then (да)
  :Получить User ID\nи confidence;
  
  |Система контроля доступа|
  :Получить событие\nраспознавания;
  
  if (Confidence ≥ 0.95?) then (да)
    :Автоматическая\nпроверка;
  else (нет)
    if (Confidence ≥ 0.6?) then (да)
      :Проверка с\nлогированием;
    else (нет)
      |Оператор охраны|
      :Ручная\nверификация;
      
      if (Подтверждение?) then (нет)
        |Система контроля доступа|
        :DENY;
        |Пользователь|
        :Доступ\nзапрещен;
        stop
      endif
      |Система контроля доступа|
    endif
  endif
  
  :Проверить\nчерный список;
  
  if (В черном списке?) then (да)
    :DENY + ALERT;
    |Оператор охраны|
    :Получить\nалерт;
    |Пользователь|
    :Доступ запрещен,\nсвязаться с охраной;
    stop
  endif
  
  |Система контроля доступа|
  :Проверить права\nдоступа;
  
  if (Есть права\nна зону?) then (нет)
    :DENY;
    |Пользователь|
    :Доступ запрещен\n(нет прав на зону);
    stop
  endif
  
  :Проверить\nвременные ограничения;
  
  if (В разрешенное\nвремя?) then (нет)
    :DENY;
    |Пользователь|
    :Доступ запрещен\n(вне рабочих часов);
    stop
  endif
  
  :Anti-tailgating\nпроверка;
  
  if (Cooldown истек?) then (нет)
    :DENY;
    |Пользователь|
    :Слишком быстрая\nпопытка прохода;
    stop
  endif
  
  :Решение: ALLOW;
  
  :Отправить команду\nконтроллеру;
  
  |Барьер/Турникет|
  :Открыть барьер;
  
  |Пользователь|
  :Пройти через КПП;
  
  |Барьер/Турникет|
  :Закрыть барьер\n(через 5 сек);
  
  |Система аудита|
  fork
    :Логировать\nуспешный проход;
  fork again
    :Сохранить\nизображение;
  fork again
    :Обновить\nстатистику;
  end fork
  
  |Пользователь|
  :Проход завершен;
  stop
  
else (нет)
  |Система распознавания|
  :Неизвестное лицо;
  
  |Система контроля доступа|
  :Алерт охране;
  
  |Оператор охраны|
  :Проверить\nизображение;
  
  if (Разрешить вход?) then (да)
    |Оператор охраны|
    :Ручное открытие\nбарьера;
    
    |Пользователь|
    :Пройти через КПП;
    stop
  else (нет)
    |Пользователь|
    :Доступ запрещен\n(не распознан);
    stop
  endif
endif

@enduml
