@startuml IDEF0_A2_Recognition
!define RECTANGLE class

skinparam defaultTextAlignment center
skinparam classBackgroundColor LightYellow
skinparam classBorderColor Black
skinparam arrowColor Black

title IDEF0 - Декомпозиция A2: Распознавание лиц и автомобилей

' Входы
rectangle "RTSP\nвидеопотоки" as input1 #LightGreen
rectangle "Кадры с\nкамер КПП" as input2 #LightGreen
rectangle "База\nembeddings" as input3 #LightGreen

' Подфункции A2
rectangle "**A2.1**\n\nЗАХВАТ И\nДЕКОДИРОВАНИЕ\nКАДРОВ" as A21 #LightSkyBlue
rectangle "**A2.2**\n\nДЕТЕКЦИЯ\nОБЪЕКТОВ" as A22 #LightSkyBlue
rectangle "**A2.3**\n\nИЗВЛЕЧЕНИЕ\nПРИЗНАКОВ" as A23 #LightSkyBlue
rectangle "**A2.4**\n\nСРАВНЕНИЕ\nС БАЗОЙ" as A24 #LightSkyBlue

' Выходы
rectangle "ID\nпользователя" as output1 #LightCoral
rectangle "Confidence\nscore" as output2 #LightCoral
rectangle "Событие\nраспознавания" as output3 #LightCoral
rectangle "Сохраненные\nизображения" as output4 #LightCoral

' Управление
rectangle "Конфигурация\nкамер" as control1 #Lavender
rectangle "Пороги\nдетекции" as control2 #Lavender
rectangle "ML модели\n(обученные)" as control3 #Lavender
rectangle "Порог\nсходства (≥0.6)" as control4 #Lavender

' Механизмы
rectangle "FFmpeg\nOpenCV" as mech1 #Wheat
rectangle "YOLOv8\nRetinaFace" as mech2 #Wheat
rectangle "ArcFace\nEasyOCR" as mech3 #Wheat
rectangle "Faiss\nRedis\nKafka" as mech4 #Wheat

' Входные потоки
input1 -right-> A21 : "H.264/H.265\nstream"
input3 -down-> A24 : "Векторы\nиз БД"

' Связи между подфункциями
A21 -right-> A22 : "Декодированные\nRGB кадры (25 FPS)"
A22 -right-> A23 : "BBox лиц,\nBBox номеров"
A23 -right-> A24 : "Face embeddings\nРаспознанный текст"

' Выходные потоки
A24 -right-> output1 : "User ID\n(если найден)"
A24 -down-> output2 : "Similarity\n0.0-1.0"
A24 -down-> output3 : "Event JSON\n(Kafka)"
A22 -down-> output4 : "Crops лиц/авто\n(MinIO)"

' Управление (сверху)
control1 -down-> A21 : "URL камер,\nFPS, разрешение"
control2 -down-> A22 : "Минимальный\nразмер объекта"
control3 -down-> A23 : "Веса моделей,\nпараметры"
control4 -down-> A24 : "Критерий\nсовпадения"

' Механизмы (снизу)
mech1 -up-> A21 : "Декодирование\nвидео"
mech2 -up-> A22 : "Детекторы\nобъектов"
mech3 -up-> A23 : "Извлечение\nпризнаков"
mech4 -up-> A24 : "Vector search,\nкэш, очередь"

note right of A21
  **Обработка потоков**:
  - Подключение к RTSP (8 камер)
  - Декодирование H.264/H.265
  - Пропуск кадров для оптимизации
  - Обработка: 5-10 FPS (из 25)
  
  **Выход**: numpy array (H×W×3)
  **Время**: ~10-20ms на кадр
end note

note right of A22
  **Детекция лиц**:
  - Модель: RetinaFace / MTCNN
  - Выход: BBox + 5 landmarks
  - Min face size: 80×80 px
  
  **Детекция авто/номеров**:
  - Модель: YOLOv8 (custom trained)
  - Классы: vehicle, license_plate
  - Confidence threshold: ≥0.7
  
  **Время**: ~50-100ms на кадр (GPU)
end note

note right of A23
  **Face Embeddings**:
  - Модель: ArcFace (ResNet-100)
  - Alignment по landmarks
  - Resize: 112×112
  - Выход: 512-dim vector
  
  **OCR для номеров**:
  - Модель: EasyOCR / CRNN
  - Предобработка: resize, normalize
  - Паттерн: RU license plates
  - Accuracy: ≥98%
  
  **Время**: ~100-150ms (GPU batch)
end note

note right of A24
  **Поиск похожих**:
  - Vector DB: Faiss (IndexFlatIP)
  - Метрика: Cosine similarity
  - Top-K: 1 результат
  - Порог: ≥0.6 (настраиваемый)
  
  **Кэширование**:
  - Redis: последние N результатов
  - TTL: 5 минут
  
  **Публикация события**:
  - Kafka topic: recognition.face
  - Формат: JSON + metadata
  
  **Время**: ~10-30ms
end note

@enduml
