@startuml C4_Component_AccessControl
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_TOP_DOWN()

title Диаграмма компонентов (C4 Level 3) - Access Control Service

Container_Ext(kafka, "Kafka", "Message Broker")
ContainerDb_Ext(postgres, "PostgreSQL", "Database")
ContainerDb_Ext(redis, "Redis", "Cache")
System_Ext(access_controllers, "Контроллеры доступа", "Физические устройства")

Container_Boundary(access_control, "Access Control Service") {
    Component(event_consumer, "Event Consumer", "Python/kafka-python", "Подписка на события распознавания из Kafka")
    Component(decision_engine, "Decision Engine", "Python", "Ядро принятия решений о предоставлении доступа")
    Component(rules_engine, "Rules Engine", "Python", "Проверка правил доступа (роли, зоны, время)")
    Component(blacklist_checker, "Blacklist Checker", "Python", "Проверка пользователя в черном списке")
    Component(access_policy_manager, "Access Policy Manager", "Python", "Управление политиками доступа")
    Component(controller_gateway, "Controller Gateway", "Python/pyserial", "Интерфейс для взаимодействия с контроллерами")
    Component(wiegand_driver, "Wiegand Driver", "C/Python", "Драйвер для работы с протоколом Wiegand")
    Component(rs485_driver, "RS-485 Driver", "C/Python", "Драйвер для работы с протоколом RS-485/Modbus")
    Component(command_executor, "Command Executor", "Python", "Выполнение команд (OPEN, CLOSE) на контроллерах")
    Component(state_monitor, "State Monitor", "Python", "Мониторинг состояния контроллеров и барьеров")
    Component(cache_service, "Cache Service", "Python/redis-py", "Кэширование правил доступа и пользователей")
    Component(event_publisher, "Event Publisher", "Python/kafka-python", "Публикация решений и событий в Kafka")
    Component(notification_trigger, "Notification Trigger", "Python", "Триггеры для отправки уведомлений")
}

Rel(kafka, event_consumer, "Подписан на топики", "recognition.face / recognition.vehicle")
Rel(event_consumer, decision_engine, "Передает события распознавания", "event object")

Rel(decision_engine, rules_engine, "Проверяет правила доступа", "user_id, zone_id, timestamp")
Rel(decision_engine, blacklist_checker, "Проверяет черный список", "user_id")
Rel(decision_engine, cache_service, "Получает кэшированные данные", "")

Rel(rules_engine, cache_service, "Читает правила из кэша", "")
Rel(cache_service, redis, "Управляет кэшем", "Redis Protocol")
Rel(cache_service, postgres, "Загружает данные в кэш", "SQL")

Rel(access_policy_manager, postgres, "Читает/пишет политики", "SQL")
Rel(blacklist_checker, postgres, "Проверяет черный список", "SQL")

Rel(decision_engine, command_executor, "Отправляет решение", "ALLOW/DENY + metadata")
Rel(command_executor, controller_gateway, "Формирует команду", "command object")

Rel(controller_gateway, wiegand_driver, "Использует драйвер Wiegand", "binary protocol")
Rel(controller_gateway, rs485_driver, "Использует драйвер RS-485", "Modbus RTU")

Rel(wiegand_driver, access_controllers, "Отправляет команды", "Wiegand 26/34-bit")
Rel(rs485_driver, access_controllers, "Отправляет команды", "RS-485/Modbus")

Rel(access_controllers, state_monitor, "Передает состояние", "status signals")
Rel(state_monitor, controller_gateway, "Обновляет состояние", "")

Rel(decision_engine, event_publisher, "Публикует решения", "decision object")
Rel(event_publisher, kafka, "Отправляет события", "access.decision")

Rel(decision_engine, notification_trigger, "Триггерит уведомления", "alert data")
Rel(notification_trigger, kafka, "Публикует алерты", "notifications")

SHOW_LEGEND()

@enduml
