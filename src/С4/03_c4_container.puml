@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()

title Диаграмма контейнеров (C4 Level 2) - Система умного КПП

Person(security_guard, "Сотрудник охраны", "Оператор КПП")
Person(admin, "Администратор", "Управляет системой")
Person(user, "Пользователь", "Проходит через КПП")

System_Ext(cameras, "IP-камеры", "RTSP видеопотоки")
System_Ext(access_controllers, "Контроллеры доступа", "Wiegand/RS-485")
System_Ext(notification_ext, "Внешние сервисы", "Email, Telegram")
System_Ext(external_systems, "Внешние системы", "ERP, Time Tracking")

System_Boundary(checkpoint, "Система умного КПП") {
    Container(web_ui, "Web UI", "React.js", "Веб-интерфейс для администраторов и операторов")
    Container(api_gateway, "API Gateway", "Kong/Traefik", "Единая точка входа, аутентификация, маршрутизация")
    
    Container(user_service, "User Service", "Python/FastAPI", "Управление пользователями, биометрией, правами доступа")
    Container(recognition_service, "Recognition Service", "Python/PyTorch", "Распознавание лиц и номеров транспортных средств")
    Container(access_service, "Access Control Service", "Python/FastAPI", "Принятие решений о доступе, управление контроллерами")
    Container(audit_service, "Audit Service", "Python/FastAPI", "Логирование событий, аналитика, отчетность")
    Container(notification_service, "Notification Service", "Python", "Отправка уведомлений и алертов")
    
    ContainerDb(postgres, "PostgreSQL", "Relational DB", "Метаданные пользователей, события, конфигурация")
    ContainerDb(redis, "Redis", "In-Memory Cache", "Кэш данных пользователей, временные данные")
    ContainerDb(minio, "MinIO", "Object Storage", "Хранилище изображений и видео")
    ContainerDb(elasticsearch, "Elasticsearch", "Search Engine", "Полнотекстовый поиск событий, логи")
    
    Container(kafka, "Apache Kafka", "Message Broker", "Асинхронная коммуникация между сервисами")
    
    Container(monitoring, "Monitoring Stack", "Prometheus/Grafana", "Мониторинг метрик и дашборды")
    Container(logging, "Logging Stack", "ELK", "Централизованное логирование")
}

Rel(security_guard, web_ui, "Использует", "HTTPS")
Rel(admin, web_ui, "Управляет", "HTTPS")

Rel(web_ui, api_gateway, "Делает запросы", "HTTPS/REST")
Rel(api_gateway, user_service, "Маршрутизирует", "HTTP/REST")
Rel(api_gateway, access_service, "Маршрутизирует", "HTTP/REST")
Rel(api_gateway, audit_service, "Маршрутизирует", "HTTP/REST")

Rel(cameras, recognition_service, "Передает видеопотоки", "RTSP")
Rel(user, cameras, "Попадает в кадр", "")

Rel(recognition_service, kafka, "Публикует события распознавания", "Kafka Protocol")
Rel(recognition_service, minio, "Сохраняет изображения", "S3 API")
Rel(recognition_service, redis, "Кэширует результаты", "Redis Protocol")

Rel(kafka, access_service, "Подписан на события", "Kafka Protocol")
Rel(kafka, audit_service, "Подписан на события", "Kafka Protocol")
Rel(kafka, notification_service, "Подписан на события", "Kafka Protocol")

Rel(user_service, postgres, "Читает/пишет данные", "SQL")
Rel(user_service, redis, "Кэширует данные", "Redis Protocol")
Rel(user_service, minio, "Сохраняет биометрию", "S3 API")

Rel(access_service, postgres, "Читает правила доступа", "SQL")
Rel(access_service, redis, "Кэширует правила", "Redis Protocol")
Rel(access_service, kafka, "Публикует решения", "Kafka Protocol")
Rel(access_service, access_controllers, "Отправляет команды", "Wiegand/RS-485")

Rel(audit_service, postgres, "Записывает события", "SQL")
Rel(audit_service, elasticsearch, "Индексирует события", "HTTP/REST")
Rel(audit_service, minio, "Архивирует медиа", "S3 API")

Rel(notification_service, notification_ext, "Отправляет уведомления", "SMTP, HTTP API")

Rel(user_service, kafka, "Публикует события пользователей", "Kafka Protocol")
Rel(audit_service, external_systems, "Экспортирует данные", "REST API/Webhook")

Rel(user_service, monitoring, "Отправляет метрики", "Prometheus")
Rel(recognition_service, monitoring, "Отправляет метрики", "Prometheus")
Rel(access_service, monitoring, "Отправляет метрики", "Prometheus")
Rel(audit_service, monitoring, "Отправляет метрики", "Prometheus")

Rel(user_service, logging, "Отправляет логи", "Logstash")
Rel(recognition_service, logging, "Отправляет логи", "Logstash")
Rel(access_service, logging, "Отправляет логи", "Logstash")
Rel(audit_service, logging, "Отправляет логи", "Logstash")

SHOW_LEGEND()

@enduml
