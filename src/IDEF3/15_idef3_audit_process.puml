@startuml IDEF3_Audit
!define RECTANGLE class

title IDEF3 - Процесс аудита и логирования (A4)

skinparam activity {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
}

|Kafka|
start
:События от всех\nсервисов;
note right
  **Действие 4.1**
  Topics:
  - recognition.face
  - recognition.vehicle
  - access.decision
  - user.registered
  - notifications
  - audit.system
  
  Producers: все микросервисы
end note

|Audit Service|
:Подписка на все\nтопики Kafka;
note right
  **Действие 4.2**
  Consumer group: audit-service
  Partitions: 8 (для параллелизма)
  Auto-commit: true
  Max poll: 500 events
end note

repeat
  :Получение batch\nсообытий;
  note right
    **Действие 4.3 (цикл)**
    Poll interval: 100ms
    Batch size: 1-500 events
    Timeout: non-blocking
  end note

  fork
    :Десериализация\nJSON;
    note right
      **Действие 4.4**
      Parse JSON → event objects
      Validation: JSON schema
      Error handling: dead letter queue
    end note

    :Обогащение\nданными;
    note right
      **Действие 4.5**
      Enrich events:
      - User name (from user_id)
      - Zone name (from zone_id)
      - Camera location
      - IP addresses
      
      Source: Redis cache / PostgreSQL
      Time: ~5-10ms per event
    end note

    :Анонимизация\n(GDPR);
    note right
      **Действие 4.6**
      Mask sensitive fields:
      - Full name → First name + last initial
      - IP → subnet only
      - Biometrics → removed
      
      Compliance: ФЗ-152, GDPR
      Reversible: only for authorized access
    end note

    :Категоризация\nсобытий;
    note right
      **Действие 4.7**
      Categories:
      - INFO: успешные действия
      - WARNING: подозрительные события
      - ERROR: ошибки системы
      - CRITICAL: критические инциденты
      
      Severity level assignment
    end note
  fork again
    :Проверка правил\nалертов;
    note right
      **Действие 4.8 (параллельно)**
      Alert rules:
      - Черный список detected → HIGH
      - Multiple failed attempts → MEDIUM
      - Service down → CRITICAL
      - Unusual activity pattern → LOW
      
      Rule engine evaluation
    end note

    if (Правило сработало?) then (да)
      :Генерация алерта;
      note right
        **Действие 4.9**
        Create alert object:
        - severity
        - message
        - affected_user
        - timestamp
        - recommended_action
      end note

      :Публикация в\nnotifications topic;
      note right
        **Действие 4.10**
        Topic: notifications
        Consumer: Notification Service
        Delivery: Telegram, Email, Push
      end note
    else (нет)
    endif
  end fork

  fork
    :Сохранение в\nPostgreSQL;
    note right
      **Действие 4.11a**
      Table: events
      Columns:
      - event_id (PK)
      - event_type
      - user_id
      - timestamp
      - metadata (JSONB)
      - severity
      
      Index: timestamp, user_id, event_type
      Batch insert: 100 events per transaction
      Time: ~50ms per batch
    end note
  fork again
    :Индексация в\nElasticsearch;
    note right
      **Действие 4.11b (параллельно)**
      Index: events-{YYYY.MM.DD}
      Mapping: dynamic + custom fields
      Purpose: full-text search
      
      Bulk API: 500 docs per request
      Refresh: 1s (near real-time)
      Time: ~100ms per batch
    end note
  fork again
    :Обновление метрик\nPrometheus;
    note right
      **Действие 4.11c (параллельно)**
      Metrics:
      - events_total{type, severity}
      - events_processing_latency
      - storage_errors_total
      
      Scrape interval: 15s
    end note
  end fork

  :Проверка политик\nхранения;
  note right
    **Действие 4.12**
    Hot data: 0-7 days (Elasticsearch)
    Warm data: 7-90 days (PostgreSQL)
    Cold data: 90-365 days (MinIO archive)
    
    Executed: hourly cron job
  end note

repeat while (Сервис работает?) is (да)
->нет;

|Пользователь (Администратор)|
:Запрос отчета;
note right
  **Действие 4.13**
  Web UI: выбор параметров отчета
  - Период (from_date, to_date)
  - Тип события (filter)
  - Группировка (user, zone, time)
  - Формат (PDF, Excel, CSV)
end note

|Audit Service|
:Валидация параметров\nзапроса;
note right
  **Действие 4.14**
  Validate:
  - Date range ≤ 1 год
  - User has permission
  - Format supported
end note

if (Параметры корректны?) then (нет)
  :Ошибка валидации;
  note right
    **Действие 4.15a**
    HTTP 400 Bad Request
    Error message
  end note
  detach
else (да)
endif

:Создание задачи\nгенерации отчета;
note right
  **Действие 4.16**
  Async task (Celery)
  Task ID: uuid
  Status: PENDING
  
  Response to user: 202 Accepted
  + task_id for polling
end note

|Background Worker|
:Выполнение задачи\nгенерации;
note right
  **Действие 4.17**
  Query data:
  - Hot: Elasticsearch (fast)
  - Warm: PostgreSQL (indexed)
  - Cold: MinIO (slow, rare)
  
  Aggregations, calculations
  Time: 10s - 5min (зависит от объема)
end note

:Формирование\nдокумента;
note right
  **Действие 4.18**
  Template: Jinja2
  
  **PDF**:
  - Library: WeasyPrint
  - Formatting: HTML → PDF
  
  **Excel**:
  - Library: openpyxl
  - Multiple sheets, charts
  
  **CSV**:
  - Raw data export
end note

:Сохранение отчета\nв MinIO;
note right
  **Действие 4.19**
  Path: /reports/{user_id}/{task_id}.{ext}
  Expiration: 7 дней
  Pre-signed URL: 24 hours valid
end note

:Обновление статуса\nзадачи;
note right
  **Действие 4.20**
  Status: COMPLETED
  Result: {
    report_url: "https://...",
    size_mb: 2.5,
    records_count: 15000
  }
end note

|Audit Service|
:Уведомление\nпользователя;
note right
  **Действие 4.21**
  Notification channels:
  - Email: ссылка на скачивание
  - WebSocket: push to UI
  - In-app notification
end note

|Пользователь (Администратор)|
:Скачивание\nотчета;
note right
  **Действие 4.22**
  Download from MinIO
  Pre-signed URL (secure)
  Expiration: 24 hours
end note

:Анализ данных;
note right
  **Действие 4.23 (конец процесса)**
  Insights:
  - Посещаемость по периодам
  - Нарушения и аномалии
  - Производительность системы
  - Рекомендации по оптимизации
end note

stop

@enduml
